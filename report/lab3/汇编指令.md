# æ±‡ç¼–æŒ‡ä»¤

## **ä¸€ã€å­—ç¬¦ä¸²å¤„ç†æŒ‡ä»¤**

(1) lodsbã€lodswã€lodslï¼šæŠŠDS:SIæŒ‡å‘çš„å­˜å‚¨å•å…ƒä¸­çš„æ•°æ®è£…å…¥ALæˆ–AXï¼Œç„¶åŽæ ¹æ®DFæ ‡å¿—å¢žå‡SIã€‚è‹¥è®¾ç½®äº†EFLAGSä¸­çš„æ–¹å‘ä½ç½®ä½(å³åœ¨STOSLæŒ‡ä»¤å‰ä½¿ç”¨STDæŒ‡ä»¤)åˆ™EDIè‡ªå‡4ï¼Œå¦åˆ™(ä½¿ç”¨CLDæŒ‡ä»¤)EDIè‡ªå¢ž4

(2) stosbã€stoswã€stoslï¼šæŠŠALæˆ–AXä¸­çš„æ•°æ®è£…å…¥ES:DIæŒ‡å‘çš„å­˜å‚¨å•å…ƒï¼Œç„¶åŽæ ¹æ®DFæ ‡å¿—å¢žå‡DI

(3) movsbã€movswã€movslï¼šæŠŠDS:SIæŒ‡å‘çš„å­˜å‚¨å•å…ƒä¸­çš„æ•°æ®è£…å…¥ES:DIæŒ‡å‘çš„å­˜å‚¨å•å…ƒä¸­ï¼Œç„¶åŽæ ¹æ®DFæ ‡å¿—åˆ†åˆ«å¢žå‡SIå’ŒDI

(4) scasbã€scaswã€scaslï¼šæŠŠALæˆ–AXä¸­çš„æ•°æ®ä¸ŽES:DIæŒ‡å‘çš„å­˜å‚¨å•å…ƒä¸­çš„æ•°æ®ç›¸å‡ï¼Œå½±å“æ ‡å¿—ä½ï¼Œç„¶åŽæ ¹æ®DFæ ‡å¿—åˆ†åˆ«å¢žå‡SIå’ŒDI

(5) cmpsbã€cmpswã€cmpslï¼šæŠŠDS:SIæŒ‡å‘çš„å­˜å‚¨å•å…ƒä¸­çš„æ•°æ®ä¸ŽES:DIæŒ‡å‘çš„å­˜å‚¨å•å…ƒä¸­çš„æ•°æ®ç›¸å‡ï¼Œå½±å“æ ‡å¿—ä½ï¼Œç„¶åŽæ ¹æ®DFæ ‡å¿—åˆ†åˆ«å¢žå‡SIå’ŒDI

(6) repï¼šé‡å¤å…¶åŽçš„ä¸²æ“ä½œæŒ‡ä»¤ã€‚é‡å¤å‰å…ˆåˆ¤æ–­CXæ˜¯å¦ä¸º0ï¼Œä¸º0å°±ç»“æŸé‡å¤ï¼Œå¦åˆ™CXå‡1ï¼Œé‡å¤å…¶åŽçš„ä¸²æ“ä½œæŒ‡ä»¤ã€‚ä¸»è¦ç”¨åœ¨MOVSå’ŒSTOSå‰ã€‚ä¸€èˆ¬ä¸ç”¨åœ¨LODSå‰ã€‚

ä¸Šè¿°æŒ‡ä»¤æ¶‰åŠçš„å¯„å­˜å™¨ï¼šæ®µå¯„å­˜å™¨DSå’ŒESã€å˜å€å¯„å­˜å™¨SIå’ŒDIã€ç´¯åŠ å™¨AXã€è®¡æ•°å™¨CX
â€‹           æ¶‰åŠçš„æ ‡å¿—ä½ï¼šDFã€AFã€CFã€OFã€PFã€SFã€ZF

## äºŒã€lealå’Œç®—æœ¯è¿ç®—æŒ‡ä»¤

> lealæŒ‡ä»¤ç”¨äºŽåŠ è½½æœ‰æ•ˆåœ°å€ï¼ˆloadeffective addressï¼‰ã€‚
>
> lealæŒ‡ä»¤çš„ç›®çš„æ“ä½œæ•°å¿…é¡»æ˜¯å¯„å­˜å™¨ã€‚å®žé™…ä¸ŠlealæŒ‡ä»¤æœ‰æ—¶ç”¨äºŽä¸ŽåŠ è½½åœ°å€æ— å…³çš„åœºæ™¯ã€‚
>
> ç¤ºä¾‹ï¼š
>
> leal 6(%eax), %edx //æŠŠeaxçš„å€¼+6æ”¾å…¥edxä¸­ã€‚
>
> leal (%eax, %ecx), %edx //æŠŠeax+ecxçš„å€¼è£…å…¥edxä¸­ã€‚
>
> leal (%eax, %ecx, 4), %edx //æŠŠeax + 4*ecxçš„å€¼è£…å…¥edxä¸­ã€‚
>
> leal 7(%eax, %eax, 8), %edx //æŠŠ9*eax +7çš„å€¼è£…å…¥edxä¸­ã€‚
>
> leal 0xA(,%eax,4), %edx //æŠŠ4*eax + 10çš„å€¼è£…å…¥edxä¸­ã€‚
>
> leal 9(%eax, %ecx, 2), %edx //æŠŠeax + 2*ecx+ 9çš„å€¼è£…å…¥edxä¸­ã€‚
>
> å¦‚ä¸‹æ˜¯ç®—æœ¯é€»è¾‘è¿ç®—æŒ‡ä»¤ï¼š
>
> inc Dï¼ŒåŠ 1ã€‚
>
> dec Dï¼Œå‡1ã€‚
>
> neg Dï¼Œå–è´Ÿæ•°ã€‚
>
> not Dï¼Œå–åã€‚
>
> add S, Dï¼ŒD= D +Sï¼ŒåŠ ã€‚
>
> sub S, Dï¼ŒD= D â€“Sï¼Œå‡ã€‚
>
> imul S, Dï¼ŒD= D * Sï¼Œ ä¹˜ã€‚
>
> xor S, Dï¼ŒD = D ^ Sï¼Œ å¼‚æˆ–ã€‚
>
> or S, Dï¼ŒD = D | Sï¼Œæˆ–ã€‚
>
> and S, Dï¼ŒD = D & Sï¼Œä¸Žã€‚

ç¤ºä¾‹ï¼š

å‡è®¾eaxå€¼æ˜¯0x100ï¼Œecxæ˜¯1ï¼Œedxæ˜¯3ã€‚

0x100çš„å€¼æ˜¯0xffï¼Œ0x104çš„å€¼æ˜¯0xabï¼Œ0x108çš„å€¼æ˜¯0x13ï¼Œ0x10cçš„å€¼æ˜¯0x11ã€‚

> addl   %ecx ï¼Œ(%eax) 				//æ›´æ–°çš„eaxå¯„å­˜å™¨æŒ‡å‘çš„å†…å­˜åœ°å€ä¸­çš„å€¼ã€‚eaxä¿å­˜åœ°å€æ˜¯0x100ï¼Œ0x100ä¸­ä¿å­˜çš„å€¼æ˜¯0xffï¼Œecxä¸­çš„å€¼æ˜¯1,é‚£ä¹ˆæ›´æ–°åŽå€¼åº”è¯¥æ˜¯0x100ã€‚
>
> subl    %edx,  4(%eax) 				//æ›´æ–°çš„æ˜¯eax+4æŒ‡å‘çš„å†…å­˜åœ°å€çš„å€¼ï¼Œä¹Ÿå°±æ˜¯0x104åœ°å€æ›´æ–°åŽçš„å€¼æ˜¯0xa8ã€‚
>
> imull   $16,  (%eax, %edx,4)		//æ›´æ–°çš„æ˜¯0x10cçš„åœ°å€ä¸­çš„å€¼ï¼Œæ›´æ–°åŽçš„å€¼æ˜¯0x110ã€‚
>
> incl  8(%eax)						 // æ›´æ–°0x108çš„åœ°å€çš„å€¼ï¼Œæ›´æ–°åŽçš„å€¼æ˜¯0x14ã€‚
>
> decl  %ecx 						// æ›´æ–°ecxçš„å€¼ï¼Œæ›´æ–°åŽçš„å€¼æ˜¯0ã€‚
>
> subl  %edx,  %eax 				//æ›´æ–°eaxçš„å€¼ï¼Œæ›´æ–°åŽçš„å€¼æ˜¯0xfdã€‚ðŸ˜˜ðŸ˜˜ðŸ˜˜

## ä¸‰ã€é¢„ç¼–è¯‘æŒ‡ä»¤

#define Â  Â  Â  Â  Â  Â å®šä¹‰ä¸€ä¸ªé¢„å¤„ç†å®
#undef Â  Â  Â  Â  Â  Â å–æ¶ˆå®çš„å®šä¹‰
#if Â  Â  Â  Â  Â  Â  Â  Â  Â  ç¼–è¯‘é¢„å¤„ç†ä¸­çš„æ¡ä»¶å‘½ä»¤ï¼Œç›¸å½“äºŽCè¯­æ³•ä¸­çš„ifè¯­å¥
#ifdef Â  Â  Â  Â  Â  Â  Â åˆ¤æ–­æŸä¸ªå®æ˜¯å¦è¢«å®šä¹‰ï¼Œè‹¥å·²å®šä¹‰ï¼Œæ‰§è¡ŒéšåŽçš„è¯­å¥
#ifndef Â  Â  Â  Â  Â  Â ä¸Ž#ifdefç›¸åï¼Œåˆ¤æ–­æŸä¸ªå®æ˜¯å¦æœªè¢«å®šä¹‰
#elif Â  Â  Â  Â  Â  Â  Â  Â è‹¥#if, #ifdef, #ifndefæˆ–å‰é¢çš„#elifæ¡ä»¶ä¸æ»¡è¶³ï¼Œåˆ™æ‰§è¡Œ#elifä¹‹åŽçš„è¯­å¥ï¼Œç›¸å½“äºŽCè¯­æ³•ä¸­çš„else-if
#else Â  Â  Â  Â  Â  Â  Â ä¸Ž#if, #ifdef, #ifndefå¯¹åº”, è‹¥è¿™äº›æ¡ä»¶ä¸æ»¡è¶³ï¼Œåˆ™æ‰§è¡Œ#elseä¹‹åŽçš„è¯­å¥ï¼Œç›¸å½“äºŽCè¯­æ³•ä¸­çš„else
#endif Â  Â  Â  Â  Â  Â  #if, #ifdef, #ifndefè¿™äº›æ¡ä»¶å‘½ä»¤çš„ç»“æŸæ ‡å¿—.
definedÂ Â Â Â Â Â  Â Â ã€€ä¸Ž#if, #elifé…åˆä½¿ç”¨ï¼Œåˆ¤æ–­æŸä¸ªå®æ˜¯å¦è¢«å®šä¹‰

\#defineå‘½ä»¤å®šä¹‰ä¸€ä¸ªå®:
\#define MACRO_NAME[(args)][tokens[(opt)]]
ä¹‹åŽå‡ºçŽ°çš„MACRO_NAMEå°†è¢«æ›¿ä»£ä¸ºæ‰€å®šä¹‰çš„æ ‡è®°(tokens)ã€‚å®å¯å¸¦å‚æ•°ï¼Œè€ŒåŽé¢çš„æ ‡è®°ä¹Ÿæ˜¯å¯é€‰çš„ã€‚

å®å®šä¹‰ï¼ŒæŒ‰ç…§æ˜¯å¦å¸¦å‚æ•°é€šå¸¸åˆ†ä¸ºå¯¹è±¡å®ã€å‡½æ•°å®ä¸¤ç§ã€‚
å¯¹è±¡å®: ä¸å¸¦å‚æ•°çš„å®è¢«ç§°ä¸º"å¯¹è±¡å®(objectlike macro)"ã€‚å¯¹è±¡å®å¤šç”¨äºŽå®šä¹‰å¸¸é‡ã€é€šç”¨æ ‡è¯†ã€‚ä¾‹å¦‚ï¼š

```c++
// å¸¸é‡å®šä¹‰
#define MAX_LENGTH 100
// é€šç”¨æ ‡è¯†ï¼Œæ—¥å¿—è¾“å‡ºå®
#define SLog printf
// é¢„ç¼–è¯‘å®
#define _DEBUG
```

å‡½æ•°å®ï¼šå¸¦å‚æ•°çš„å®ã€‚åˆ©ç”¨å®å¯ä»¥æé«˜ä»£ç çš„è¿è¡Œæ•ˆçŽ‡: å­ç¨‹åºçš„è°ƒç”¨éœ€è¦åŽ‹æ ˆå‡ºæ ˆ, è¿™ä¸€è¿‡ç¨‹å¦‚æžœè¿‡äºŽé¢‘ç¹ä¼šè€—è´¹æŽ‰å¤§é‡çš„CPUè¿ç®—èµ„æºã€‚ æ‰€ä»¥ä¸€äº›ä»£ç é‡å°ä½†è¿è¡Œé¢‘ç¹çš„ä»£ç å¦‚æžœé‡‡ç”¨å¸¦å‚æ•°å®æ¥å®žçŽ°ä¼šæé«˜ä»£ç çš„è¿è¡Œæ•ˆçŽ‡ã€‚ä½†å¤šæ•°c++ç¨‹åºä¸æŽ¨èä½¿ç”¨å‡½æ•°å®ï¼Œè°ƒè¯•ä¸Šæœ‰ä¸€å®šéš¾åº¦ï¼Œå¯è€ƒè™‘ä½¿ç”¨c++çš„inlineä»£æ›¿ä¹‹ã€‚ä¾‹å¦‚ï¼š

```c++
// æœ€å°å€¼å‡½æ•°
#define MIN(a,b) ((a)>(b)? (a):(b))
// å®‰å…¨é‡Šæ”¾å†…å­˜å‡½æ•°
#define SAFE_DELETE(p) {if(NULL!=p){delete p; p = NULL;}}
```

